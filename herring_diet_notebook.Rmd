---
title: "Diet analysis of herring predation in Puget Sound"
output: html_notebook
---


Load libraries
```{r load libraries, include=FALSE}
source("libraries.R")
source("test_herring.R")
source("test_herring_raw_data.R")
source("clean_herringdata.R")
source("make_map.R")
source("get_basin_coord.R")
source("get_raw_data.R")
```


Check full diet data set for herring prey and move to herring diet folder, add full reference

```{r check data, include=FALSE}

data.files <- list.files(path="~/herringdiet/all_diet_data",pattern = "*.xlsx", full.names = TRUE)

#Moves data files to herring data
lapply(data.files,test_herring)

data.files.raw <- list.files(path="~/herringdiet/raw_diet_data",pattern = "*.csv", full.names = TRUE)

#Moves data files to herring data
lapply(data.files.raw,test_herring_raw_data)


```


Clean raw herring data and estimate frequency of occurrence

```{r}
# add raw data clean files

source("Kwiath_diets.R")

raw.data.files <- list.files("~/herringdiet/raw_diet_data_rev", full.names = TRUE)

raw.data.files <- raw.data.files[3]

raw.data <- lapply(raw.data.files,get_raw_data) %>% 
  bind_rows %>% 
  mutate(data = as.character(data))

raw.data %>% 
  bind_rows(herring.clean.data) %>% 
  mutate(predator_stage = if_else(predator_stage=="juvenileAndadult","adult",predator_stage)) %>% 
  mutate(atlantis_pred_group = if_else(atlantis_pred_group == "STEELHEAD", "ST", atlantis_pred_group)) %>% 
  write_csv("herring_diet_data.csv")
```



```{r clean herring data}


data.folder <- "~/herringdiet/herring_data_rev"

data.files <- list.files(path=data.folder,pattern = "*.xlsx", full.names = TRUE)

herring.clean.data <- lapply(data.files, clean_herringdata, diet.names="diet_file_list.csv", predator.list = "herring_predator_names.csv") %>% 
  bind_rows

diet.file.names <- read_csv("diet_file_list.csv") %>% 
  rename(file_name = FILE, reference = CITA)

herring.clean.data %>% 
  mutate(file_name=gsub(".xlsx","",file_name)) %>% 
  left_join(diet.file.names, by="file_name") %>% 
  distinct(file_name, reference) %>% 
  #filter(is.na(reference)) %>% 
  write_csv("herring_references.csv")

  #using all predators
  #selected groups are 
  #pred.groups <- c("HSL","PIN","SAL","SB","FMM","CI","CO","CU","DOG","PIS","ROC","MRO","SMD","SP")
  
  
herring.clean.data %>% 
  #filter(is.na(latitude) & !is.na(longitude)) %>% 
  distinct(location, latitude,longitude) %>% 
  arrange(location) %>% 
  write_csv("herring_locations.csv")

#join with Raw data and convert predator_size based on units





```


Plot sampling points and map

```{r make map, echo=FALSE}

#https://boundingbox.klokantech.com/
#-123.7904,47.0152,-121.9301,49.2511 Puget Sound

shape.file <- "USMaritimeLimitsNBoundaries.shp"
boundary.file <- "shapefile_4071.shp"
file.name <- "herring_map.png"
scale.factor <- 2 #map scale
bar.position  <- "tl" #position scale bar
max.long <- -121.9
min.long <- -125
min.lat <- 46
max.lat <- 50
herring.locations <-"herring_diet_data.csv"

make_map(shape.file, boundary.file, file.name, scale.factor, bar.position, max.long, min.long, min.lat, max.lat, herring.locations)

```


Assign each data point to a basin

```{r assign basin, echo=TRUE}

herring.locations <-"herring_diet_data.csv"
boundary.file <- "shapefile_4071.shp"


herring.basin.data <- get_basin_coord(herring.locations, boundary.file)

write_csv(herring.basin.data, "herring_diet_basin_data.csv")

```


Summarize number of samples by categories
```{r}

herring.data <- read_csv("herring_diet_basin_data.csv")

basin.data <- herring.data %>% 
  mutate(index_rows = 1) %>% 
  group_by(atlantis_pred_group, predator_stage, basin) %>%
  summarize(tot_data = sum(index_rows))

ps.data <- herring.data %>% 
  mutate(index_rows = 1) %>% 
  group_by(atlantis_pred_group, predator_stage) %>%
  summarize(tot_data = sum(index_rows))

herring.data %>% 
  distinct(atlantis_pred_group, predator_taxa) %>% 
  arrange(atlantis_pred_group, predator_taxa)

red.pal1 <- redmonder.pal(8,"qMSOMed")[3:8]

sample.plot <- basin.data %>% 
      ggplot(aes(x=atlantis_pred_group, y=tot_data, fill = predator_stage)) + 
      geom_col()+
      scale_fill_manual(values=red.pal1, name = "Predator stage")+
      theme_classic()+
      theme(legend.position = "bottom")+
      ylab("Data samples") + 
      xlab("Predator group") 
    # stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1, colour="grey50")  #quadratic
    #  stat_smooth(method = 'lm', formula = y ~ poly(x,2), aes(colour = 'polynomial'), se= FALSE)+
 
red.pal2 <- redmonder.pal(8,"qMSOMed")

basin.plot <- basin.data %>% 
      ggplot(aes(x=atlantis_pred_group, y=tot_data, fill = basin)) + 
      geom_col()+
      scale_fill_manual(values=red.pal2, name = "Basin")+
      theme_classic()+
      theme(legend.position = "bottom")+
      ylab("Data samples") + 
      xlab("Predator group") 
    # stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1, colour="grey50")  #quadratic
    #  stat_smooth(method = 'lm', formula = y ~ poly(x,2), aes(colour = 'polynomial'), se= FALSE)+
   

grid.sample <- grid.arrange(sample.plot, basin.plot, ncol=1)

    ggsave("herring_samples_plot.png", grid.sample, device="png",width=9,dpi=350)
    


  
```


Fit model
```{r}

#used http://jacolienvanrij.com/Tutorials/GAMM.html
#https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/

herring.basin.data <- read_csv("herring_diet_basin.data.csv")


#with factor include intercept difference: Group + s(Time, by=Group).

#with ordered factor include intercept difference and reference smooth: Group + s(Time) + s(Time, by=Group).

#with binary predictor include reference smooth: s(Time) + s(Time, by=IsGroupChildren).
#m2 <- gam(value + basin ~ s(year), data=herring.basin.data)


gam(value ~ basin + s(year) + s(value, by=basin), data=herring.basin.data)

#random smooths adjust the trend of a numeric predictor in a nonlinear way: s(Time, Subject, bs="fs", m=1).

gam.model <- gam(value ~ atlantis_pred_group + s(year, by=basin)
      + s(year, basin, bs="fs", m=1), data=herring.basin.data)


herring.basin.data.mod <- herring.basin.data %>% 
  mutate(predator_stage = as.factor(predator_stage)) %>% 
   mutate(atlantis_pred_group = as.factor(atlantis_pred_group)) %>% 
  mutate(sample_source = as.factor(sample_source)) %>% 
  mutate(variable = as.factor(variable))


m1 <- gam(value ~ year + 
          s(year, by = atlantis_pred_group)+
          s(year, by = basin)+
          s(predator_size, predator_stage, bs='fs', m=1)+
          s(year, sample_source, bs='fs', m=1) ,
          data = herring.basin.data.mod, 
          rho=valRho)
      

#check the distribution and autocorrelation structure of the residuals:

check_resid(m1, split_by=c("year", "basin"))

summary(gam.model)

save(m1, file="m1.rda", compress='xz')

# set two plot panels:
par(mfrow=c(1,2), cex=1.1)

# Plot difference surface:
plot_diff2(m1, view=c("year", "predator-stage"), 
    comp=list(Group=c("adults", "juveniles")), 
    plotCI=TRUE, rm.ranef=TRUE,
    main="Adults-Juveniles",
    zlim=c(-13,13))

# plot differences per condition:
for(i in -1:4){
  add=TRUE
  if(i==-1){
    add = FALSE
  }
  p <- plot_diff(m1.rho, view="Time", 
    comp=list(Group=c("Adults", "Children")),
    cond=list(Condition=i),
    ylim=c(-13,13),
    main="Adults-Children",
    col=rainbow(6)[i+2], add=add,
    rm.ranef=TRUE)
  text(2000, p$est[length(p$est)], pos=4, labels=i, col=rainbow(6)[i+2],
       font=2, xpd=TRUE)
}

```



```{r}

herring.basin.data <- read_csv("herring_diet_basin.data.csv")

herring.predator <- herring.basin.data %>% 
  group_by(atlantis_pred_group) %>% 
  summarise(tot_entries = n()) %>% 
  arrange(desc(tot_entries))

herring.predator.year <- herring.data %>% 
  group_by(atlantis_pred_group, year) %>% 
  summarise(tot_entries = n()) %>% 
  arrange(desc(year,atlantis_pred_group,tot_entries))


```


Check if original data sums to 1, part of the assessment of how original data were calculated. 

```{r}

data.path <- "/home/atlantis/herringdiet/herring_data/"
file.list <- list.files(data.path,pattern = "*.*xlsx")

data.summary <- lapply(file.list,check_herringdata, data.path)

data.sums <- data.summary %>% 
  bind_rows

prop.sum.data <- data.sums %>% 
  group_by(data,location,file_name,year,author,publication_yr) %>% 
  mutate(sum_test=if_else(prop_sum == 100, "100",if_else(prop_sum<100, "<100", ">100") )) %>% 
  ungroup %>% 
  distinct(file_name,year,publication_yr,author,sum_test)

write_csv(prop.sum.data,"summary_herring_data.csv")
```



Extra code
```{r}
#used geocoding to get locations, but ended up going through each article to find the maps and find the corresponding coordinates
# revised data files are in herring_data_rev

# location.table <- lapply(sampling.locations,get_location) %>% 
#   bind_rows
# 
# write_csv(location.table,"sampling_coordinates.csv")
# # I reviewed this manually for missing data, and saved as "sampling_coordinates_rev.csv"
# 
# location.data <- read_csv("sampling_coordinates_rev.csv")
# 
# herring.loc.corr <- herring.clean.data %>% 
#   filter(latitude==0) %>% 
#   dplyr::select(-latitude,-longitude) %>% 
#   left_join(location.data,by="location")
# 
# herring.loc.data <- herring.clean.data %>% 
#   filter(!latitude==0) %>% 
#   bind_rows(herring.loc.corr)
```

