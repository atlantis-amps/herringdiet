---
title: "Diet analysis of herring predation in Puget Sound"
output: html_notebook
---


Load libraries
```{r load libraries, include=FALSE}
source("libraries.R")
source("test_herring.R")
source("test_herring_raw_data.R")
source("clean_herringdata.R")
source("make_map.R")
```


Check full diet data set for herring prey and move to herring diet folder, add full reference

```{r check data, include=FALSE}

data.files <- list.files(path="~/herringdiet/all_diet_data",pattern = "*.xlsx", full.names = TRUE)

#Moves data files to herring data
lapply(data.files,test_herring)

data.files.raw <- list.files(path="~/herringdiet/raw_diet_data",pattern = "*.csv", full.names = TRUE)

#Moves data files to herring data
lapply(data.files.raw,test_herring_raw_data)


```

```{r clean herring data}


#used geocoding to get locations, but ended up going through each article to find the maps and find the corresponding coordinates
# revised data files are in herring_data_rev

# location.table <- lapply(sampling.locations,get_location) %>% 
#   bind_rows
# 
# write_csv(location.table,"sampling_coordinates.csv")
# # I reviewed this manually for missing data, and saved as "sampling_coordinates_rev.csv"
# 
# location.data <- read_csv("sampling_coordinates_rev.csv")
# 
# herring.loc.corr <- herring.clean.data %>% 
#   filter(latitude==0) %>% 
#   dplyr::select(-latitude,-longitude) %>% 
#   left_join(location.data,by="location")
# 
# herring.loc.data <- herring.clean.data %>% 
#   filter(!latitude==0) %>% 
#   bind_rows(herring.loc.corr)

data.folder <- "~/herringdiet/herring_data_rev"

data.files <- list.files(path=data.folder,pattern = "*.xlsx", full.names = TRUE)

herring.clean.data <- lapply(data.files, clean_herringdata, diet.names="diet_file_list.csv", predator.list = "herring_predator_names.csv") %>% 
  bind_rows

print("Save reference table")
  
  herring.clean.data %>% 
    mutate(file_name=gsub(".xlsx","",file_name)) %>% 
    mutate(file_name=gsub("/home/atlantis/herringdiet/all_diet_data/","",file_name)) %>% 
    left_join(diet.file.names, by="file_name") %>% 
    distinct(file_name, reference) %>% 
   # filter(is.na(reference)) %>% 
    write_csv("herring_references.csv")
  
  #using all predators
  #selected groups are 
  #pred.groups <- c("HSL","PIN","SAL","SB","FMM","CI","CO","CU","DOG","PIS","ROC","MRO","SMD","SP")
  
  
herring.clean.data %>% 
  filter(!is.na(latitude) & !is.na(longitude)) %>% 
  distinct(location, latitude,longitude) %>% 
  arrange(location) %>% 
  write_csv("herring_locations.csv")

herring.clean.data %>% 
  write_csv("herring_diet_data.csv")
```



Plot sampling points and map

```{r}

#https://boundingbox.klokantech.com/
#-123.7904,47.0152,-121.9301,49.2511 Puget Sound

shape.file <- "USMaritimeLimitsNBoundaries.shp"
file.name <- "herring_map.png"
scale.factor <- 2 #map scale
bar.position  <- "tl" #position scale bar
max.long <- -121.9
min.long <- -125
min.lat <- 46
max.lat <- 50
herring.locations <-"herring_diet_data.csv"

make_map(shape.file, file.name, scale.factor, bar.position, max.long, min.long, min.lat, max.lat, herring.locations)

```


```{r}
herring.predator <- herring.data %>% 
  group_by(atlantis_pred_group) %>% 
  summarise(tot_entries = n()) %>% 
  arrange(desc(tot_entries))

herring.predator.year <- herring.data %>% 
  group_by(atlantis_pred_group, year) %>% 
  summarise(tot_entries = n()) %>% 
  arrange(desc(year,atlantis_pred_group,tot_entries))


```


Check if original data sums to 1, part of the assessment of how original data were calculated. 

```{r}

data.path <- "/home/atlantis/herringdiet/herring_data/"
file.list <- list.files(data.path,pattern = "*.*xlsx")

data.summary <- lapply(file.list,check_herringdata, data.path)

data.sums <- data.summary %>% 
  bind_rows

prop.sum.data <- data.sums %>% 
  group_by(data,location,file_name,year,author,publication_yr) %>% 
  mutate(sum_test=if_else(prop_sum == 100, "100",if_else(prop_sum<100, "<100", ">100") )) %>% 
  ungroup %>% 
  distinct(file_name,year,publication_yr,author,sum_test)

write_csv(prop.sum.data,"summary_herring_data.csv")
```

